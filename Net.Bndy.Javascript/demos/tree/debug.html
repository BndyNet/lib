<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../base.css" rel="stylesheet" />
    <script type="text/javascript" src="../../jquery/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="../../jqueryui/jquery-ui-1.10.2/js/jquery-ui-1.10.2.custom.js"></script>
    <script type="text/javascript">
        function refreshNode(node) {
            var next = $(node).next();
            if (next.hasClass('node-child') && next.find('.node').length > 0) {
                // Has child
                if ($(node).data('expand')) {
                    $(node).find('.ico').html('-');
                }
                else {
                    $(node).find('.ico').html('+');
                }
            }
            else {
               // Leaf
                $(node).find('.ico').html('&nbsp;&nbsp;');
            }
        }

        function newNode(nodeText, nodeIdentity, parent, hasChild) {
            var nodeWrap = $('<div class="node"></div>');
            var icoWrap = $('<span class="ico">&nbsp;</span>');
            var textWrap = $('<span class="text"></span>');
            var optWrap = $('<span class="opt"></span>');
            
            icoWrap.appendTo(nodeWrap);
            textWrap.appendTo(nodeWrap);
            optWrap.appendTo(nodeWrap);

            var path = "";
            if (parent != undefined)
                path = $(parent).data('path') + $(parent).attr('id') + '\\';

            icoWrap.css('padding-left', (path.split('\\').length - 1) * 20);
            textWrap.text(nodeText);

            nodeWrap.attr('id', nodeIdentity);
            nodeWrap.removeClass('hidden');
            nodeWrap.data('path', path);

            optWrap.text('');

            // Add operations
            var opts = [
                $('<span class="delete btn">Delete</span>'),
                $('<span class="add btn">Add Child</span>'),
                $('<span class="insert btn">Insert</span>')
            ];

            for (var x = 0; x < opts.length; x++) {
                opts[x].appendTo(optWrap);
                if (x != opts.length - 1)
                    optWrap.append($('<span class="split"> | </span>'));
            }

            var tree = $('#Tree');
            if (parent !== undefined) {
                var box = $(parent).next();
                if (!box.hasClass('node-child')) {
                    box = $('<div class="node-child"></div>');
                    box.insertAfter(parent);

                    $(parent).data('expand', true);
                }
                nodeWrap.appendTo(box);
            }
            else
                nodeWrap.appendTo(tree);

            refreshNode(parent);
            return nodeWrap;
        }

        function RenderNode(json, parentNode) {
            for (var i = 0; i < json.length; i++) {
                var no = json[i].no;
                var id = json[i].id;
                var name = json[i].name;
                var children = json[i].children;

                var p = newNode(name, id, parentNode, children !== undefined && children.length > 0);
                if (children !== undefined && children.length > 0) {
                    RenderNode(children, p);
                }
            }
        }

        $(function () {
            $.ajax({
                url: "../data.json",
                success: function (data, event) {
                    var data = JSON.parse(data);
                    RenderNode(data);

                    // Effects
                    $('.tree').on('mouseover', '.node', function () {
                        $(this).addClass('highlight');
                    });
                    $('.tree').on('mouseout', '.node', function () {
                        $(this).removeClass('highlight');
                    });
                    $('.tree').sortable({ revert: true });
                    $('.draggable').draggable({
                        connectToSortable: '.tree'
                    });
                    $('.tree').on('click', '.ico', function () {
                        var nextBox = $(this).parent().next();

                        if (nextBox.hasClass('node-child')) {
                            if ($(this).parent().data('expand')) {
                                $(this).parent().data('expand', false)
                                nextBox.hide();
                            }
                            else {
                                $(this).parent().data('expand', true)
                                nextBox.show();
                            }
                            refreshNode($(this).parent());
                        }
                    });

                    // Operations
                    $('.tree').on('click', '.delete', function (data) {
                        if (confirm('Are you sure to delete this item?')) {
                            // Delete the item.
                            $(this).parent().parent().remove();
                        }
                    });
                    $('.tree').on('click', '.add', function (data) {
                        var node = $(this).parent().parent();
                        $('#FormAddChild').dialog({
                            width: 360,
                            model: true,
                            buttons: {
                                Submit: function () {
                                    var name = $(this).find('#txtNo').val() + ' ' + $(this).find('#txtName').val();
                                    newNode(name, "B", node);
                                    $(this).dialog('close');
                                    refreshNode(node);
                                },
                                Close: function () {
                                    $(this).dialog('close');
                                }
                            }
                        });
                    });
                }
            });
        });
    </script>
</head>
<body>
    <div id="Tree" class="tree">
    </div>

    <div id="FormAddChild" class="frm" style="width: 380px; display: none;">
        <div class="field">
            <div class="field-label">No</div>
            <div class="field-input">
                <input type="text" id="txtNo" />
            </div>
        </div>
        <div class="field">
            <div class="field-label">Name</div>
            <div class="field-input">
                <input type="text" id="txtName" />
            </div>
        </div>
    </div>
</body>
</html>
